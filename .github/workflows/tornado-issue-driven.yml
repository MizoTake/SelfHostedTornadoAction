name: "Tornado: Issue-Driven Multi-Agent Development"

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

# åŒæ™‚å®Ÿè¡Œã‚’åˆ¶å¾¡ï¼ˆåŒä¸€issueã«å¯¾ã—ã¦1ã¤ã ã‘å®Ÿè¡Œï¼‰
concurrency:
  group: tornado-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  tornado-run:
    name: "Run Tornado Agent"
    runs-on: [self-hosted, Windows]

    # ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶:
    #   A) Issue opened ã§ tornado ãƒ©ãƒ™ãƒ«ã‚ã‚Š
    #   B) labeled ã‚¤ãƒ™ãƒ³ãƒˆã§ã€ä»˜ä¸ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ãŒ tornado ã®æ™‚ã ã‘
    #   C) Issue ã‚³ãƒ¡ãƒ³ãƒˆãŒ /tornado ã§å§‹ã¾ã‚Šã€tornado ãƒ©ãƒ™ãƒ«ã‚ã‚Šã€PR ã§ã¯ãªã„
    if: >-
      (
        github.event_name == 'issues'
        && github.event.action == 'opened'
        && contains(github.event.issue.labels.*.name, 'tornado')
      )
      || (
        github.event_name == 'issues'
        && github.event.action == 'labeled'
        && github.event.label.name == 'tornado'
      )
      || (
        github.event_name == 'issue_comment'
        && contains(github.event.issue.labels.*.name, 'tornado')
        && !github.event.issue.pull_request
        && startsWith(github.event.comment.body, '/tornado')
      )

    timeout-minutes: 60

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      TORNADO_NPM_PACKAGE: "@mizchi/tornado@0.4.0"
      # Unity é–¢é€£ï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒªãƒã‚¸ãƒˆãƒª Secrets / Variables ã§ä¸Šæ›¸ãï¼‰
      UNITY_EDITOR_PATH: ${{ vars.UNITY_EDITOR_PATH || 'C:\Program Files\Unity\Hub\Editor' }}

    defaults:
      run:
        shell: powershell

    steps:
      # â”€â”€ 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ 2. Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      # â”€â”€ 3. gh CLI ã®ç¢ºèª â”€â”€
      - name: Verify gh CLI
        run: |
          gh --version
          gh auth status

      # â”€â”€ 4. Issue æƒ…å ±ã®å–å¾—ãƒ»ãƒ‘ãƒ¼ã‚¹ â”€â”€
      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: Issue/ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã¯ gh CLI çµŒç”±ã§å–å¾—ã—ã€
      #   ${{ }} ã®ç›´æ¥å±•é–‹ã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’å›é¿
      - name: Fetch issue body and build plan
        id: parse-issue
        env:
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REPO: ${{ github.repository }}
        run: |
          $PlanFile = Join-Path $env:RUNNER_TEMP "tornado_plan_$($env:ISSUE_NUMBER).md"

          # Issue body ã‚’ gh CLI çµŒç”±ã§å®‰å…¨ã«å–å¾—
          gh issue view $env:ISSUE_NUMBER --json body --jq '.body' | Out-File -FilePath $PlanFile -Encoding utf8

          # ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã®å ´åˆ: ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ gh API ã‹ã‚‰å®‰å…¨ã«å–å¾—
          if ($env:EVENT_NAME -eq 'issue_comment' -and $env:COMMENT_ID) {
            $CommentBody = gh api "/repos/$($env:REPO)/issues/comments/$($env:COMMENT_ID)" --jq '.body'

            # /tornado ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦è¿½åŠ æŒ‡ç¤ºã¨ã—ã¦æ‰±ã†
            $ExtraInstruction = $CommentBody -replace '^/tornado\s*', ''

            if ($ExtraInstruction) {
              "`n---`n## Additional Instructions`n`n$ExtraInstruction" | Out-File -FilePath $PlanFile -Append -Encoding utf8
            }
          }

          "plan_file=$PlanFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # â”€â”€ 5. Issue ã‚¿ã‚¤ãƒˆãƒ«ã®å®‰å…¨ãªå–å¾— â”€â”€
      - name: Fetch issue title
        id: issue-meta
        run: |
          $Title = gh issue view $env:ISSUE_NUMBER --json title --jq '.title'
          "title=$Title" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # â”€â”€ 6. å®Ÿè¡Œé–‹å§‹ã‚’ Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆ â”€â”€
      - name: Notify execution start
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RUN_ID: ${{ github.run_id }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          $BranchName = "tornado/issue-$($env:ISSUE_NUMBER)"
          $Timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss 'UTC'")

          $Body = @"
          ğŸŒªï¸ **Tornado å®Ÿè¡Œé–‹å§‹**

          | é …ç›® | å€¤ |
          |------|-----|
          | Run ID | [``$($env:RUN_ID)``]($($env:RUN_URL)) |
          | ãƒˆãƒªã‚¬ãƒ¼ | ``$($env:EVENT_NAME)`` |
          | ãƒ–ãƒ©ãƒ³ãƒ | ``$BranchName`` |
          | Runner OS | Windows (Unityå¯¾å¿œ) |
          | é–‹å§‹æ™‚åˆ» | $Timestamp |

          å‡¦ç†ä¸­ã§ã™ã€‚å®Œäº†å¾Œã«ã“ã® Issue ã«ãƒ¬ãƒãƒ¼ãƒˆã—ã¾ã™...
          "@

          gh issue comment $env:ISSUE_NUMBER --body $Body

      # â”€â”€ 7. ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆ â”€â”€
      - name: Create or switch to working branch
        run: |
          $BranchName = "tornado/issue-$($env:ISSUE_NUMBER)"

          # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã®å­˜åœ¨ç¢ºèª
          $RemoteRef = git ls-remote --heads origin $BranchName 2>$null
          if ($RemoteRef) {
            git fetch origin $BranchName
            git checkout -B $BranchName "origin/$BranchName"
          } else {
            git checkout -b $BranchName origin/main
          }

          "BRANCH_NAME=$BranchName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      # â”€â”€ 8. Tornado å®Ÿè¡Œ â”€â”€
      - name: Install and run Tornado
        id: tornado
        run: |
          $PlanFile = "${{ steps.parse-issue.outputs.plan_file }}"
          $LogFile = Join-Path $env:RUNNER_TEMP "tornado_output_$($env:ISSUE_NUMBER).log"

          Write-Host "::group::Tornado Execution"

          # tornado.json ãŒã‚ã‚Œã° plan ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          if (Test-Path "./tornado.json") {
            Write-Host "Using tornado.json config..."
            Copy-Item $PlanFile -Destination "./.tornado_plan_tmp.md"
            $ExecPlan = "./.tornado_plan_tmp.md"
          } else {
            Write-Host "Running with plan file directly..."
            $ExecPlan = $PlanFile
          }

          # Tornado å®Ÿè¡Œï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰
          $ExitCode = 0
          try {
            npx -y $env:TORNADO_NPM_PACKAGE $ExecPlan --dev=claude --review=codex 2>&1 | Tee-Object -FilePath $LogFile
            $ExitCode = $LASTEXITCODE
          } catch {
            $ExitCode = 1
            $_ | Out-File -FilePath $LogFile -Append -Encoding utf8
          }

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆgit add ã•ã‚Œã‚‹å‰ã«ï¼‰
          Remove-Item -Path "./.tornado_plan_tmp.md" -ErrorAction SilentlyContinue

          Write-Host "::endgroup::"

          "exit_code=$ExitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "log_file=$LogFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      # â”€â”€ 9. å¤‰æ›´ã®æ¤œå‡ºã¨ã‚³ãƒŸãƒƒãƒˆ â”€â”€
      - name: Commit changes
        id: commit
        env:
          ISSUE_TITLE: ${{ steps.issue-meta.outputs.title }}
        run: |
          git config user.name "tornado-bot"
          git config user.email "tornado-bot@users.noreply.github.com"

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
          ".tornado_plan_tmp.md" | Out-File -FilePath ".git/info/exclude" -Append -Encoding utf8

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          $Status = git status --porcelain
          if ($Status) {
            git add -A
            git commit -m "ğŸŒªï¸ tornado: Issue #$($env:ISSUE_NUMBER) - $($env:ISSUE_TITLE)"
            git push origin $env:BRANCH_NAME --force-with-lease
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      # â”€â”€ 10. Pull Request ã®ä½œæˆ â”€â”€
      - name: Create or update Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        id: pr
        env:
          ISSUE_TITLE: ${{ steps.issue-meta.outputs.title }}
        run: |
          # æ—¢å­˜PRãŒã‚ã‚‹ã‹ç¢ºèª
          $ExistingPR = gh pr list --head $env:BRANCH_NAME --json number --jq '.[0].number // empty'

          if ($ExistingPR) {
            "pr_number=$ExistingPR" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "PR #$ExistingPR already exists, pushed new commits."
          } else {
            $PrBody = @"
          ## Tornado Auto-Generated PR

          **Source Issue:** #$($env:ISSUE_NUMBER)
          **Agent Config:** dev=claude, review=codex
          **Runner:** Windows (Unityå¯¾å¿œ)

          ---

          ã“ã®PRã¯ Tornado ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          Issue ã®å†…å®¹ã«åŸºã¥ã„ã¦ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

          ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
          "@

            $PrUrl = gh pr create `
              --title "ğŸŒªï¸ [Tornado] Issue #$($env:ISSUE_NUMBER): $($env:ISSUE_TITLE)" `
              --body $PrBody `
              --head $env:BRANCH_NAME `
              --base main

            # PRç•ªå·ã‚’æŠ½å‡º
            $PrNumber = ($PrUrl -split '/')[-1]
            "pr_number=$PrNumber" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      # â”€â”€ 11. çµæœã‚’ Issue ã«ãƒ¬ãƒãƒ¼ãƒˆ â”€â”€
      - name: Report results to issue
        if: always()
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          $ExitCode = "${{ steps.tornado.outputs.exit_code }}"
          $HasChanges = "${{ steps.commit.outputs.has_changes }}"
          $PrNumber = "${{ steps.pr.outputs.pr_number }}"
          $LogFile = "${{ steps.tornado.outputs.log_file }}"
          $Timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss 'UTC'")

          # ãƒ­ã‚°ã®æœ«å°¾ã‚’æŠ½å‡º
          if ($LogFile -and (Test-Path $LogFile)) {
            $LogLines = Get-Content $LogFile -Tail 100 -ErrorAction SilentlyContinue
            $LogTail = ($LogLines -join "`n")
            if ($LogTail.Length -gt 3000) {
              $LogTail = $LogTail.Substring($LogTail.Length - 3000)
            }
          } else {
            $LogTail = "(ãƒ­ã‚°ãªã—)"
          }

          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®š
          if ($ExitCode -eq "0") {
            $Status = "âœ… æˆåŠŸ"
            $Emoji = "ğŸ‰"
          } else {
            $Status = "âŒ å¤±æ•— (exit code: $ExitCode)"
            $Emoji = "âš ï¸"
          }

          # PRæƒ…å ±
          if ($PrNumber) {
            $PrInfo = "**Pull Request:** #$PrNumber"
          } elseif ($HasChanges -eq "false") {
            $PrInfo = "**å¤‰æ›´ãªã—:** ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          } else {
            $PrInfo = "**PR:** æœªä½œæˆ"
          }

          $Body = @"
          $Emoji **Tornado å®Ÿè¡Œå®Œäº†**

          | é …ç›® | å€¤ |
          |------|-----|
          | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | $Status |
          | å®Œäº†æ™‚åˆ» | $Timestamp |
          | Actions Run | [ãƒ­ã‚°ã‚’ç¢ºèª]($($env:RUN_URL)) |

          $PrInfo

          <details>
          <summary>ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°ï¼ˆæœ«å°¾ï¼‰</summary>

          ``````
          $LogTail
          ``````

          </details>

          ---
          ğŸ’¡ è¿½åŠ ã®ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€ã“ã®Issueã« ``/tornado <è¿½åŠ æŒ‡ç¤º>`` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
          "@

          gh issue comment $env:ISSUE_NUMBER --body $Body

      # â”€â”€ 12. å¤±æ•—æ™‚ã®ãƒ©ãƒ™ãƒ«ä»˜ä¸ â”€â”€
      - name: Label on failure
        if: failure()
        run: |
          gh issue edit $env:ISSUE_NUMBER --add-label "tornado-failed"

      # â”€â”€ 13. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— â”€â”€
      - name: Cleanup temporary files
        if: always()
        run: |
          $PlanFile = Join-Path $env:RUNNER_TEMP "tornado_plan_$($env:ISSUE_NUMBER).md"
          $LogFile = Join-Path $env:RUNNER_TEMP "tornado_output_$($env:ISSUE_NUMBER).log"

          Remove-Item -Path $PlanFile -ErrorAction SilentlyContinue
          Remove-Item -Path $LogFile -ErrorAction SilentlyContinue
          Remove-Item -Path "./.tornado_plan_tmp.md" -ErrorAction SilentlyContinue
